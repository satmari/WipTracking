{% extends 'core/base.html' %}
{% load static %}

{% block title %}Declarations{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Declarations</h1>

    <div class="btn-group">
      <a href="{% url 'planners:declaration_wizard' %}"
         class="btn btn-primary btn-sm">
        + Add declaration
      </a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <!-- auto-init-filters: base.html će automatski inicijalizovati DataTable i filtere -->
      <table id="declaration-table" class="table table-striped table-hover mb-0 auto-init-filters" style="width:100%;">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Team user</th>
            <th>Subdepartment</th>
            <th>PRO</th>
            <th>Routing</th>
            <th>Operation</th>
            <th>Qty</th>
            <th>SMV</th>
            <th>SMV ITA</th>
            <th>Operators</th>
            <th>Created</th>
            <th>Updated</th>
            <th class="text-end" style="width:180px;">Actions</th>
          </tr>

          <!-- FILTER ROW (drugi <tr> u thead). data-column indeksi počinju od 0 -->
          <tr>
            <th><input class="form-control form-control-sm column-filter" data-column="0" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="1" placeholder="Filter… (d.m.Y)"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="2" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="3" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="4" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="5" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="6" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="7" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="8" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="9" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="10" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="11" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="12" placeholder="Filter…"></th>

            <th></th>
          </tr>
        </thead>

        <tbody>
          {% for d in declarations %}
          <tr>
            <td>{{ d.id }}</td>
            <td>{{ d.decl_date|date:"d.m.Y." }}</td>

            <td>
              {% if d.teamuser %}
                {{ d.teamuser.username }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              {% if d.subdepartment %}
                {{ d.subdepartment.subdepartment }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>{{ d.pro.pro_name }}</td>

            <td>
              {% if d.routing %}
                {{ d.routing.sku }}{% if d.routing.version %} (v{{ d.routing.version }}){% endif %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              {% if d.routing_operation %}
                {{ d.routing_operation.operation }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>{{ d.qty }}</td>
            <td>{{ d.smv }}</td>
            <td>{{ d.smv_ita }}</td>

            <td>
              {% if d.op_count %}
                {% with ops=d.operators.all %}
                  {% for op in ops|slice:":3" %}
                    <span class="badge bg-light text-dark me-1">{{ op.badge_num }} - {{ op.name }}</span>
                  {% endfor %}
                  {% if ops|length > 3 %}
                    <span class="text-muted">+{{ ops|length|add:"-3" }}</span>
                  {% endif %}
                {% endwith %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>{{ d.created_at|date:"d.m.Y. H:i" }}</td>
            <td>{{ d.updated_at|date:"d.m.Y. H:i" }}</td>

            <td class="text-end">
              <a href="{% url 'planners:declaration_view' d.id %}" class="btn btn-sm btn-outline-info me-1">View</a>
              <a href="{% url 'planners:declaration_edit' d.id %}" class="btn btn-sm btn-outline-secondary me-1">Edit</a>
              <a href="{% url 'planners:declaration_delete' d.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="14" class="text-center text-muted py-4">No declarations found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<style>
  .column-filter { min-width:60px; max-width:200px; font-size:.85rem; padding:2px 4px; }
</style>


<script>
  $(function(){
    window.initTableWithColumnFilters('#declaration-table', {
      pageLength: 25,
      lengthMenu: [10,25,50,100],
      order: [[1, 'desc']],
      columnDefs: [{ orderable: false, targets: -1 }]
    });
  });
</script>

<script>
$(document).ready(function () {
    let table = $('#declaration-table');

    // ako DataTable već postoji — unisti ga
    if ($.fn.dataTable.isDataTable(table)) {
        table.DataTable().destroy();
    }

    // ponovna inicijalizacija sa željenim default orderom
    initTableWithColumnFilters('#declaration-table', {
        order: [[0, 'desc']]   // sort by ID desc
    });
});
</script>


{% endblock %}
