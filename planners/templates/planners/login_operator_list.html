{% extends 'core/base.html' %}
{% load static %}

{% block title %}Operator Logins{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Operator logins</h1>

    <div class="d-flex gap-2">
      <a href="{% url 'planners:login_operator_add' %}"
         class="btn btn-primary btn-sm">
        + Add login
      </a>

      <a href="{% url 'planners:login_operator_logout_wizard' %}"
         class="btn btn-warning btn-sm">
        + Add logout
      </a>

      <!-- MANUAL AUTO-LOGOUT -->
      <form method="post"
            action="{% url 'planners:manual_logout_operators' %}"
            class="d-inline">
        {% csrf_token %}
        <button type="submit"
                class="btn btn-danger btn-sm"
                onclick="return confirm('Run manual auto-logout for operators?');">
          Run manual auto-logout
        </button>
      </form>

      <!-- AUTO BREAK 30 -->
      <form method="post"
            action="{% url 'planners:manual_assign_break_30' %}"
            class="d-inline">
        {% csrf_token %}
        <button type="submit"
                class="btn btn-secondary btn-sm"
                onclick="return confirm('Assign 30 min break for full-shift operators without break?');">
          Auto break 30 min
        </button>
      </form>
    </div>
  </div>

  {% if break_null_count > 0 %}
    <div class="alert alert-warning mb-3">
      ⚠️ <strong>{{ break_null_count }}</strong>
      operator login{{ break_null_count|pluralize }} have missing break.
    </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">

      <table id="login-ops-table"
             class="table table-striped table-hover mb-0 auto-init-filters"
             style="width: 100%;">
        <thead class="table-light">

          <!-- MAIN HEADER -->
          <tr>
            <th>ID</th>
            <th>Operator</th>
            <th>Team user</th>

            <th>Login actual</th>
            <th>Login team date</th>
            <th>Login team time</th>

            <th>Logoff actual</th>
            <th>Logoff team date</th>
            <th>Logoff team time</th>

            <th>Status</th>
            <th>Break (min)</th>
            <th class="text-end">Actions</th>
          </tr>

          <!-- FILTER ROW -->
          <tr>
            <th><input class="form-control form-control-sm column-filter" data-column="0"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="1"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="2"></th>

            <th><input class="form-control form-control-sm column-filter" data-column="3"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="4"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="5"></th>

            <th><input class="form-control form-control-sm column-filter" data-column="6"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="7"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="8"></th>

            <th>
              <select class="form-select form-select-sm column-filter" data-column="9">
                <option value="">All</option>
                <option value="ACTIVE">ACTIVE</option>
                <option value="COMPLETED">COMPLETED</option>
                <option value="IGNORE">IGNORE</option>
              </select>
            </th>

            <!-- BREAK FILTER (INPUT, NOT DROPDOWN) -->
            <th>
              <input type="text"
                     class="form-control form-control-sm column-filter"
                     data-column="10"
                     placeholder="None / 0–30">
            </th>

            <th></th>
          </tr>
        </thead>

        <tbody>
          {% for lo in login_operators %}
          <tr>
            <td>{{ lo.id }}</td>
            <td>{{ lo.operator }}</td>
            <td>{{ lo.team_user }}</td>

            <td>{{ lo.login_actual|date:"d.m.Y. H:i" }}</td>
            <td>{{ lo.login_team_date|date:"d.m.Y." }}</td>
            <td>{{ lo.login_team_time|time:"H:i" }}</td>

            <td>
              {% if lo.logoff_actual %}
                {{ lo.logoff_actual|date:"d.m.Y. H:i" }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>

            <td>
              {% if lo.logoff_team_date %}
                {{ lo.logoff_team_date|date:"d.m.Y." }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>

            <td>
              {% if lo.logoff_team_time %}
                {{ lo.logoff_team_time|time:"H:i" }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>

            <td>{{ lo.get_status_display }}</td>

            <td>
              {% if lo.break_time is not None %}
                {{ lo.break_time }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>

            <td class="text-end">
              <a href="{% url 'planners:login_operator_edit' lo.pk %}"
                 class="btn btn-sm btn-outline-secondary">
                Edit
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="12" class="text-center text-muted py-4">
              No operator logins yet.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<style>
  .column-filter {
    min-width: 60px;
    max-width: 200px;
    font-size: .85rem;
    padding: 2px 4px;
  }
</style>

<script>
$(document).ready(function () {
    let table = $('#login-ops-table');

    if ($.fn.dataTable.isDataTable(table)) {
        table.DataTable().destroy();
    }

    let dt = initTableWithColumnFilters('#login-ops-table', {
        order: [[0, 'desc']]
    });

    // -------------------------------------------------
    // EXACT MATCH FILTER FOR "Break (min)" COLUMN
    // -------------------------------------------------
    const breakCol = 10;

    $('input.column-filter[data-column="' + breakCol + '"]').on('keyup change', function () {
        let val = $(this).val().trim();

        if (!val) {
            dt.column(breakCol).search('').draw();
            return;
        }

        if (val.toLowerCase() === 'none') {
            dt.column(breakCol).search('^None$', true, false).draw();
            return;
        }

        if (/^\d+$/.test(val)) {
            dt.column(breakCol).search('^' + val + '$', true, false).draw();
            return;
        }

        // invalid input → no results
        dt.column(breakCol).search('a^').draw();
    });
});
</script>
{% endblock %}
