{% extends "core/base.html" %}
{% load static %}

{% block title %}Operator Capacity{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">
      Operator Capacity – {{ selected_date|date:"d.m.Y" }}
    </h1>
    <a href="{% url 'planners:planner_dashboard' %}"
       class="btn btn-sm btn-outline-secondary">
      ← Back
    </a>
  </div>

  <!-- DATE FILTER -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
      <label class="form-label small mb-0">Date</label>
      <input type="date"
             name="date"
             value="{{ selected_date|date:'Y-m-d' }}"
             class="form-control form-control-sm">
    </div>
    <div class="col-auto">
      <button class="btn btn-sm btn-primary">Apply</button>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="card-body p-0">

      <table id="capacity-table"
             class="table table-sm table-striped mb-0 w-100">

        <thead class="table-light">
          <tr>
            <th>Operator</th>
            <th>Team</th>
            <th>Available (min)</th>
            <th>Worked (min)</th>
            <th class="text-end">Eff %</th>
          </tr>
          <tr>
            <th><input class="form-control form-control-sm column-filter"></th>
            <th><input class="form-control form-control-sm column-filter"></th>
            <th></th><th></th><th></th>
          </tr>
        </thead>

        <tbody>
        {% for row in rows %}
          <tr
            {% if row.efficiency < 50 %}class="table-danger"
            {% elif row.efficiency < 70 %}class="table-warning"
            {% elif row.efficiency > 100 %}class="table-success"
            {% endif %}
          >
            <td>
              <strong>{{ row.operator.badge_num }}</strong><br>
              <span class="text-muted small">{{ row.operator.name }}</span>
            </td>

            <td class="small">{{ row.team|default:"—" }}</td>

            <td class="small">
              {% for r in row.session_ranges %}
                {{ r }}{% if not forloop.last %} + {% endif %}
              {% endfor %}
              {% if row.break_minutes %} − {{ row.break_minutes }} break{% endif %}
              {% if row.downtime_minutes %} − {{ row.downtime_minutes }} downtime{% endif %}
              = <strong>{{ row.available_min }}</strong>
            </td>

            <td class="small">
              {% if row.worked_min %}
                <strong>{{ row.worked_min }}</strong><br>
                <span class="text-muted">{{ row.worked_formula }}</span>
              {% else %}
                0
              {% endif %}
            </td>

            <td class="text-end">
              <strong>{{ row.efficiency }}%</strong>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              No operator activity for selected date.
            </td>
          </tr>
        {% endfor %}
        </tbody>

      </table>

    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
$(function () {
  $('#capacity-table').DataTable({
    order: [[4, 'desc']],
    pageLength: 25,
    searching: true,
    ordering: true
  });
});
</script>

{% endblock %}
