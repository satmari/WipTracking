{% extends 'core/base.html' %}
{% load static %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Calendar</h1>
    <div>
      <a href="{% url 'planners:calendar_add' %}" class="btn btn-primary btn-sm">
        + Add team calendar
      </a>
      <a href="{% url 'planners:calendar_delete' %}" class="btn btn-outline-danger btn-sm">
        - Delete calendar by team
      </a>
    </div>
  </div>

  <!-- NAV TABOVI -->
  <ul class="nav nav-tabs mb-3" id="calendarTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-calendar-view"
              data-bs-toggle="tab" data-bs-target="#calendar-pane"
              type="button" role="tab" aria-controls="calendar-pane"
              aria-selected="true">
        Calendar view
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-table-view"
              data-bs-toggle="tab" data-bs-target="#table-pane"
              type="button" role="tab" aria-controls="table-pane"
              aria-selected="false">
        Table view
      </button>
    </li>
  </ul>

  <div class="tab-content" id="calendarTabsContent">

    <!-- KALENDAR TAB -->
    <div class="tab-pane fade show active" id="calendar-pane" role="tabpanel" aria-labelledby="tab-calendar-view">
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Team calendar</span>
          <div>
            <button id="btn-view-month" class="btn btn-sm btn-outline-secondary me-1">Month</button>
            <button id="btn-view-week" class="btn btn-sm btn-outline-secondary">Week</button>
          </div>
        </div>
        <div class="card-body">
          <div id="team-calendar"></div>
        </div>
      </div>
    </div>

    <!-- TABLE TAB -->
    <div class="tab-pane fade" id="table-pane" role="tabpanel" aria-labelledby="tab-table-view">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">
          Calendar – table view
        </div>
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0" id="calendar-table" style="width:100%;">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Team User</th>
                <th>Subdepartment</th>
                <th>Calendar</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              {% for c in calendar_entries %}
              <tr>
                <td>{{ c.date|date:"d.m.Y." }}</td>
                <td>{{ c.team_user.username }}</td>
                <td>{{ c.team_user.subdepartment }}</td>
                <td>{{ c.shift_start|time:"H:i" }} – {{ c.shift_end|time:"H:i" }}</td>
                <td>{{ c.updated_at|date:"d.m.Y. H:i" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No calendar entries yet.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div> <!-- tab-content -->

</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}

  <!-- FullCalendar CSS & JS sa CDN-a -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <style>
    #team-calendar .fc-event {
      font-size: 0.75rem;
      line-height: 1.2;
      border-radius: 0.4rem;
      padding: 1px 3px;
    }
    #team-calendar .fc-daygrid-event-dot {
      display: none;
    }
    #team-calendar .fc-event-main {
      white-space: normal;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {

      // ======================================================
      //  DJANGO → RAW EVENTS
      // ======================================================
      const rawEvents = [
        {% for c in calendar_entries %}
        {
          id: {{ c.id }},
          title: "{{ c.team_user.username|escapejs }}",
          start: "{{ c.date|date:'Y-m-d' }}T{{ c.shift_start|time:'H:i:s' }}",
          end: "{{ c.date|date:'Y-m-d' }}T{{ c.shift_end|time:'H:i:s' }}",
          extendedProps: {
            teamUser: "{{ c.team_user.username|escapejs }}",
            shiftStart: "{{ c.shift_start|time:'H:i' }}",
            shiftEnd: "{{ c.shift_end|time:'H:i' }}"
          }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];

      // ======================================================
      //  PALETA – dovoljno boja, jaka paleta
      // ======================================================
      const strongPalette = [
        "#e6194B", "#3cb44b", "#ffe119", "#4363d8",
        "#f58231", "#911eb4", "#42d4f4", "#f032e6",
        "#bfef45", "#fabed4", "#469990", "#dcbeff",
        "#9A6324", "#fffac8", "#800000", "#aaffc3",
        "#808000", "#ffd8b1", "#000075", "#a9a9a9"
      ];

      // Jedinstveni teamUser-i redom kojim se pojavljuju
      const uniqueUsers = [];
      rawEvents.forEach(ev => {
        const u = ev.extendedProps.teamUser;
        if (u && !uniqueUsers.includes(u)) uniqueUsers.push(u);
      });

      function getUserColor(username) {
        const idx = uniqueUsers.indexOf(username);
        if (idx === -1) return "#999999";
        return strongPalette[idx % strongPalette.length];
      }

      function lightenHex(hex, percent) {
        const num = parseInt(hex.slice(1), 16);
        let r = (num >> 16) + percent;
        let g = ((num >> 8) & 0x00FF) + percent;
        let b = (num & 0x0000FF) + percent;

        r = Math.min(255, Math.max(0, r));
        g = Math.min(255, Math.max(0, g));
        b = Math.min(255, Math.max(0, b));

        return "#" + (b | (g << 8) | (r << 16)).toString(16).padStart(6, "0");
      }

      // ======================================================
      //  FULLCALENDAR
      // ======================================================
      const calendarEl = document.getElementById('team-calendar');
      const now = new Date();

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        firstDay: 1,
        navLinks: true,
        selectable: false,

        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },

        dayHeaderFormat: { day: '2-digit', month: '2-digit' },
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

        events: rawEvents,

        // ***** OVDE JE IZMENJENO — SAMO teamUser! *****
        eventContent: function(arg) {
          const p = arg.event.extendedProps;
          const timeRange = `${p.shiftStart}–${p.shiftEnd}`;

          const container = document.createElement('div');

          const timeDiv = document.createElement('div');
          timeDiv.textContent = timeRange;

          const titleDiv = document.createElement('div');
          titleDiv.textContent = p.teamUser;   // ← SAMO TEAM USER

          container.appendChild(timeDiv);
          container.appendChild(titleDiv);

          return { domNodes: [container] };
        },

        eventDidMount: function(info) {
          const p = info.event.extendedProps;
          const baseColor = getUserColor(p.teamUser);

          const isPast = info.event.start < now;

          const bg = isPast ? lightenHex(baseColor, 90) : baseColor;
          const border = isPast ? lightenHex(baseColor, 60) : baseColor;
          const text = isPast ? "#555" : "#000";

          info.el.style.backgroundColor = bg;
          info.el.style.borderColor = border;
          info.el.style.color = text;
        }
      });

      calendar.render();

      document.getElementById('btn-view-month').addEventListener('click', () => {
        calendar.changeView('dayGridMonth');
      });
      document.getElementById('btn-view-week').addEventListener('click', () => {
        calendar.changeView('timeGridWeek');
      });

      // ======================================================
      //  DATATABLES
      // ======================================================
      let calendarTable = null;
      function initCalendarTable() {
        if (!calendarTable) {
          calendarTable = $('#calendar-table').DataTable({
            order: [[0, 'desc']],
            paging: true,
            pageLength: 20,
            lengthMenu: [10, 20, 50, 100],
            searching: true,
            scrollX: true,
            fixedHeader: true
          });
          new $.fn.dataTable.FixedHeader(calendarTable);
        } else {
          calendarTable.columns.adjust();
        }
      }
      $(document).ready(() => initCalendarTable());

      const tableTab = document.getElementById('tab-table-view');
      tableTab.addEventListener('shown.bs.tab', function() {
        if (calendarTable) {
          setTimeout(() => calendarTable.columns.adjust(), 200);
        }
      });
    });
  </script>
{% endblock %}
