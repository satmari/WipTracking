{% extends 'core/base.html' %}
{% load static %}

{% block title %}PRO List{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">PRO List</h1>
    <a href="{% url 'planners:pro_add' %}" class="btn btn-primary btn-sm">Add PRO manualy</a>
    <a href="{% url 'planners:posummary_lookup' %}" class="btn btn-secondary btn-sm">Add PRO from POSummary</a>
    <form method="post" action="{% url 'planners:pro_update_from_posummary' %}" class="d-inline">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Update ALL active PRO from POSummary?');">
        Update all PRO from POSummary
      </button>
    </form>
  </div>


  {% if pros_without_routing_count %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center mb-3">
      <div>
        <strong>{{ pros_without_routing_count }}</strong>
        PRO / Subdepartment combination(s) have <strong>no routing</strong>.
      </div>

      <details class="ms-3">
        <summary class="cursor-pointer small">Show list</summary>
        <ul class="small mt-2 mb-0">
          {% for item in pros_without_routing %}
            <li>
              <strong>{{ item.pro.pro_name }}</strong>
              (SKU: {{ item.pro.sku }}) —
              {{ item.subdepartment.subdepartment }}
            </li>
          {% endfor %}
        </ul>
      </details>
    </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">

      <table class="table table-striped table-hover mb-0 auto-init-filters"
             id="pro-table" style="width:100%;">

        <thead class="table-light">

          <tr>
            <th>ID</th>
            <th>PRO Name</th>
            <th>SKU</th>
            <th>Qty</th>
            <th>Del. date</th>
            <th>Status</th>
            <th>Destination</th>
            <th>TPP</th>
            <th>Skeda</th>
            <th>Subdepartments</th>
            <th>Updated</th>
            <th class="text-end">Actions</th>
          </tr>

          <tr>
            <th><input class="form-control form-control-sm column-filter" data-column="0" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="1" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="2" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="3" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="4" placeholder="Filter…"></th>

            <th>
              <select class="form-select form-select-sm column-filter" data-column="5">
                <option value="">All</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </th>

            <th><input class="form-control form-control-sm column-filter" data-column="6" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="7" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="8" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="9" placeholder="Filter…"></th>
            <th><input class="form-control form-control-sm column-filter" data-column="10" placeholder="Filter…"></th>
            <th></th>
          </tr>

        </thead>

        <tbody>
          {% for pro in pros %}
          <tr>
            <td>{{ pro.id }}</td>
            <td>{{ pro.pro_name }}</td>
            <td>{{ pro.sku|default:"-" }}</td>
            <td>{{ pro.qty|default:"-" }}</td>
            <td>{% if pro.del_date %}{{ pro.del_date|date:"d.m.Y." }}{% else %}-{% endif %}</td>

            <td>
              {% if pro.status %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>

            <td>{{ pro.destination|default:"-" }}</td>
            <td>{{ pro.tpp|default:"-" }}</td>
            <td>{{ pro.skeda|default:"-" }}</td>

            <td>
              {% for rel in pro.pro_subdepartments.all %}
                {% if rel.active %}
                  <span class="badge bg-secondary mb-1">{{ rel.subdepartment.subdepartment }}</span>
                {% endif %}
              {% empty %}
                <span class="text-muted small">No subdepartments</span>
              {% endfor %}
            </td>

            <td>{{ pro.updated_at|date:"d.m.Y H:i" }}</td>

            <td class="text-end">
              <a href="{% url 'planners:pro_edit' pro.pk %}"
                 class="btn btn-sm btn-outline-primary">Edit</a>
              <a class="btn btn-sm btn-outline-danger ms-1 disabled">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>

    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<style>
  .column-filter { min-width:60px; max-width:200px; font-size:.85rem; padding:2px 4px; }
  details summary { cursor:pointer; }
</style>

<script>
$(document).ready(function () {
    initTableWithColumnFilters('#pro-table', {
        order: [[0, 'desc']],
        order: [[0, 'desc']],
        columnDefs: [
            { targets: 4, type: 'date-eu' },
            { targets: 10, type: 'date-eu' }
        ]
    });
});
</script>

{% endblock %}
