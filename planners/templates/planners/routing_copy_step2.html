{% extends 'core/base.html' %}
{% load static %}

{% block title %}Copy routing – step 2{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h5 mb-0">Copy routing – step 2/2</h1>
      <div class="text-muted small">
        From:
        <strong>{{ source_routing.sku }}</strong> /
        <strong>{{ source_routing.subdepartment }}</strong> /
        <strong>{{ source_routing.version }}</strong>
        → To new SKU:
        <strong>{{ target_sku }}</strong>
      </div>
    </div>

    <a href="{% url 'planners:routing_copy_step1' %}" class="btn btn-outline-secondary btn-sm">
      ← Back
    </a>
  </div>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="source_id" value="{{ source_routing.id }}">
    <input type="hidden" name="target_sku" value="{{ target_sku }}">

    <div class="card shadow-sm">
      <div class="card-body p-0">

        <table class="table table-striped table-hover mb-0" id="routing-copy-table" style="width:100%;">
          <thead class="table-light">
            <tr>
              <th style="width:40px;" class="text-center">
                <input type="checkbox" id="select-all">
              </th>
              <th>Operation</th>
              <th>Description</th>
              <th>SMV</th>
              <th>Final op</th>
            </tr>
          </thead>
          <tbody>
            {% for ro in routing_ops %}
            <tr>
              <td class="text-center">
                <input type="checkbox"
                       name="selected_ops"
                       value="{{ ro.id }}"
                       class="form-check-input">
              </td>
              <td>{{ ro.operation.name }}</td>
              <td>{{ ro.operation_description }}</td>
              <td>{{ ro.smv }}</td>
              <td>
                {% if ro.final_operation %}
                  <span class="badge bg-success">Yes</span>
                {% else %}
                  <span class="badge bg-secondary">No</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                This routing has no operations to copy.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

      </div>
    </div>

    <div class="mt-3 d-flex justify-content-between">
      <div class="text-muted small">
        Selected operations will be copied to the routing for SKU <strong>{{ target_sku }}</strong>.
        If a routing with the same subdepartment and version already exists,
        existing operations will be skipped — only missing ones will be added.
      </div>
      <div>
        <a href="{% url 'planners:routing_list' %}" class="btn btn-secondary btn-sm">
          Cancel
        </a>
        <button type="submit" class="btn btn-primary btn-sm">
          Confirm copy
        </button>
      </div>
    </div>

  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('select-all');
    if (!selectAll) return;

    selectAll.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('input[name="selected_ops"]');
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
    });
  });
</script>
{% endblock %}
